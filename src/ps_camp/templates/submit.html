{% extends "base.html" %}
{% block content %}

<script>
  const now = "{{ now }}";
  const candidateDeadline = "{{ candidate_deadline }}";
  const allianceDeadline = "{{ alliance_deadline }}";

  console.log("ğŸ•’ ç¾åœ¨æ™‚é–“ï¼š", now);
  console.log("ğŸ“Œ å€™é¸äººæˆªæ­¢ï¼š", candidateDeadline);
  console.log("ğŸ“Œ è¯ç›Ÿå”å®šæˆªæ­¢ï¼š", allianceDeadline);

  // å¦‚æœæƒ³è½‰æˆ Date ç‰©ä»¶ï¼ˆå¯æ¯”è¼ƒï¼‰
  const nowDate = new Date(now);
  const candidateDate = new Date(candidateDeadline);
  const allianceDate = new Date(allianceDeadline);

  console.log("æ¯”è¼ƒçµæœï¼š", nowDate < candidateDate, nowDate > allianceDate);
</script>


<div class="container">
<div class="submit-container">
  {% if role == "party" %}
  <div class="submit-header">
    <h2>å€™é¸äººæå</h2>
    <p>å‰©é¤˜åé¡ï¼š<span id="remaining">{{ remaining_slots }}</span> / 6</p>
  </div>

  {% if remaining_slots == 0 %}
  <p class="limit-warning">æ‚¨å·²æå 6 ä½å€™é¸äººï¼Œç„¡æ³•å†æ–°å¢ã€‚</p>
  {% endif %}

  <form method="POST" class="submit-form" enctype="multipart/form-data">
    
    <table class="member-table">
      <thead>
        <tr>
          <th>é¸æ“‡</th>
          <th>å§“å</th>
          <th>å¸³è™Ÿ</th>
        </tr>
      </thead>
      <tbody>
        {% for member in members %}
        {% if member.id not in existing_candidates | map(attribute='user_id') | list %}
        <tr>
          <td><input type="checkbox" name="selected_members" value="{{ member.id }}" {% if not can_upload_candidate %}disabled{% endif %}></td>
          <td>{{ member.fullname }}</td>
          <td>{{ member.username }}</td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
    
    {% if can_upload_candidate %}
    <label for="description">æ”¿è¦‹ï¼ˆé¸å¡«ï¼‰</label>
    <textarea name="description" rows="4" placeholder="è«‹è¼¸å…¥è©²å€™é¸äººçš„æ”¿è¦‹..."></textarea>

    <label>ä¸Šå‚³å€™é¸äººç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
    <div class="file-dropzone" data-input-id="photo_input" data-label-id="photo_label">
      <p id="photo_label" style="color: #ced4da;">é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³åœ–ç‰‡</p>
      <input type="file" id="photo_input" name="photo_zip" accept=".zip" hidden>
    </div>

    <label>ä¸Šå‚³å»ºè¨­æ€§å…§é–£åå–®ï¼ˆPDFï¼‰</label>
    <div class="file-dropzone" data-input-id="cabinet_input" data-label-id="cabinet_label">
      <p id="cabinet_label" style="color: #ced4da;">é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³ PDF æª”æ¡ˆ</p>
      <input type="file" id="cabinet_input" name="cabinet_pdf" accept="application/pdf" hidden>
    </div>

    {% if party_doc and party_doc.cabinet_url %}
    <p>
      <i class="fas fa-paperclip"></i>
      <a href="{{ party_doc.cabinet_url }}" target="_blank">å·²ä¸Šå‚³ï¼šé»æˆ‘ä¸‹è¼‰</a>
    </p>
    {% endif %}
    
    <button type="submit" class="submit-button">ä¸Šå‚³å€™é¸äºº & å»ºè¨­æ€§å…§é–£åå–®</button>
    {% else %}
    <div class="disabled-form">
      <p style="color: gray;">âš  å€™é¸äººæåèˆ‡å»ºè¨­æ€§å…§é–£åå–®å·²æˆªæ­¢</p>
    </div>
    {% endif %}

    {% if can_upload_alliance %}
    <label>ä¸Šå‚³æ”¿é»¨è¯ç›Ÿå”å®šæ›¸ï¼ˆPDFï¼‰</label>
    <div class="file-dropzone" data-input-id="alliance_input" data-label-id="alliance_label">
      <p id="alliance_label" style="color: #ced4da;">é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³ PDF æª”æ¡ˆ</p>
      <input type="file" id="alliance_input" name="alliance_pdf" accept="application/pdf" hidden>
    </div>
    {% if party_doc and party_doc.alliance_url %}
    <p>
      <i class="fas fa-paperclip" style="margin-right: 4px;"></i>
      <a href="{{ party_doc.alliance_url }}" target="_blank">å·²ä¸Šå‚³ï¼šé»æˆ‘ä¸‹è¼‰</a>
    </p>

    <button type="submit" class="submit-button">ä¸Šå‚³æ”¿é»¨è¯ç›Ÿå”å®šæ›¸</button>
    {% endif %}
    {% else %}
    <div class="disabled-form">
      <p style="color: gray;">âš  æ”¿é»¨è¯ç›Ÿå”å®šæ›¸å·²æˆªæ­¢</p>
    </div>
    {% endif %}
  </form>

  {% if existing_candidates %}
  <div class="existing-section">
    <h3>å·²æåå€™é¸äºº</h3>
    <ul class="existing-list">
      {% for c in existing_candidates %}
      <li>{{ c.name }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% elif role == "group" %}
  <div class="submit-header">
    <h2>æäº¤å…¬æŠ•æ¡ˆ</h2>
  </div>
  <form method="POST"
    class="submit-form {% if (role == 'party' and expired_party) or (role == 'group' and expired_group) %}disabled-form{% endif %}"
    enctype="multipart/form-data">
    
    <label for="title">å…¬æŠ•æ¡ˆæ¨™é¡Œ</label>
    <input type="text" id="title" name="title" required placeholder="è«‹è¼¸å…¥æ¸…æ¥šæ˜ç¢ºçš„æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šåå°è²ªæ±¡ç‰¹èµ¦æ³•æ¡ˆ">

    <label for="description">å…¬æŠ•æ¡ˆèªªæ˜</label>
    <textarea id="description" name="description" rows="4" placeholder="è«‹ç°¡è¦èªªæ˜æ­¤å…¬æŠ•æ¡ˆçš„èƒŒæ™¯ã€ç›®çš„æˆ–å½±éŸ¿..."></textarea>

    <label>ä¸Šå‚³å…¬æŠ•æ¡ˆ PDF</label>
    <div class="file-dropzone" data-input-id="proposal_pdf" data-label-id="proposal_label">
      <p id="proposal_label" style="color: #ced4da;">é»æ“Šæˆ–æ‹–æ›³ä¸Šå‚³ PDF æª”æ¡ˆ</p>
      <input type="file" id="proposal_pdf" name="proposal_pdf" accept="application/pdf" hidden>
    </div>

    {% if proposal and proposal.file_url %}
    <p>
      <i class="fas fa-paperclip" style="margin-right: 4px;"></i>
      <a href="{{ proposal.file_url }}" target="_blank">å·²ä¸Šå‚³ï¼šé»æˆ‘ä¸‹è¼‰</a>
      <span style="margin-left: 8px; font-size: 0.9em; color: #6c757d;">ï¼ˆå¯é‡æ–°é¸æ“‡ä»¥è¦†è“‹ï¼‰</span>
    </p>
    {% endif %}


    <button type="submit" class="submit-button">æäº¤å…¬æŠ•æ¡ˆ</button>
  </form>
  {% endif %}
</div>
</div>
{% endblock %}